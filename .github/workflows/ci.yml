name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BAZEL_VERSION: "6.0.0"

jobs:
  # Basic testing job
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Run all tests
      run: bazel test //test/... --test_output=all
      
    - name: Build examples
      run: bazel build //examples/... --verbose_failures
      
    - name: Check formatting
      run: bazel run @bazel_skylib//tools:buildifier -- --mode=check $(find . -name "*.bzl" -o -name "BUILD*" -o -name "*.bazel")

  # Integration testing job
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Run integration tests
      run: bazel run //test:integration_test_comprehensive
      
    - name: Test simple example
      run: bazel test //examples/simple_rust_verification:simple_verification_test
      
    - name: Test advanced example
      run: bazel test //examples/advanced_rust_integration:complete_proof_test

  # Cross-platform testing matrix
  cross-platform:
    name: Cross-Platform Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Test platform-specific functionality
      run: bazel test //test:toolchain_test --test_arg=--platform=${{ matrix.platform }}
      
    - name: Build platform examples
      run: bazel build //examples/... --verbose_failures

  # Documentation build job
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install documentation tools
      run: pip install markdown-link-check
      
    - name: Check markdown links
      run: find . -name "*.md" -exec markdown-link-check {} \;
      
    - name: Validate README structure
      run: |
        echo "‚úÖ README.md exists"
        test -f README.md
        echo "‚úÖ README.md has proper sections"
        grep -q "## Features" README.md
        grep -q "## Quick Start" README.md
        grep -q "## Examples" README.md

  # Release validation job
  release:
    name: Release Validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Validate release readiness
      run: |
        echo "‚úÖ Checking checksums are valid"
        python3 -c "
        import json
        with open('checksums/tools/rocq.json') as f:
            data = json.load(f)
        for version_data in data['versions'].values():
            for platform_data in version_data['platforms'].values():
                sha256 = platform_data['sha256']
                assert len(sha256) == 64, f'Invalid checksum length: {len(sha256)}'
                assert all(c in '0123456789abcdef' for c in sha256), 'Invalid checksum characters'
        print('‚úÖ All checksums are valid SHA256 format')
        "
        
        echo "‚úÖ Checking toolchain files exist"
        test -f toolchains/rocq_toolchain.bzl
        test -f toolchains/tool_registry.bzl
        test -f coq_of_rust/toolchain.bzl
        
        echo "‚úÖ Checking examples exist"
        test -d examples/simple_rust_verification
        test -d examples/advanced_rust_integration
        
        echo "‚úÖ Checking tests exist"
        test -f test/integration_test_comprehensive.bzl
        test -f test/coq_of_rust_test.bzl
        
        echo "‚úÖ Release is ready!"

  # Nightly performance testing
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    schedule:
      - cron: '0 0 * * *'  # Run at midnight UTC
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Run performance tests
      run: |
        echo "üìä Running performance tests..."
        
        # Time the simple example
        echo "Testing simple example..."
        time bazel build //examples/simple_rust_verification:simple_rust
        
        # Time the advanced example
        echo "Testing advanced example..."
        time bazel build //examples/advanced_rust_integration:advanced_rust
        
        # Time the integration tests
        echo "Testing integration..."
        time bazel test //test:integration_test_comprehensive
        
        echo "‚úÖ Performance tests completed"

  # Dependency update checker
  dependencies:
    name: Dependency Updates
    runs-on: ubuntu-latest
    schedule:
      - cron: '0 0 * * 0'  # Run weekly on Sunday
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check for Bazel updates
      run: |
        echo "üîç Checking for Bazel updates..."
        latest_bazel=$(curl -s https://api.github.com/repos/bazelbuild/bazel/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
        echo "Latest Bazel version: $latest_bazel"
        echo "Current version: ${{ env.BAZEL_VERSION }}"
        
        if [ "$latest_bazel" != "${{ env.BAZEL_VERSION }}" ]; then
          echo "‚ö†Ô∏è Bazel update available: $latest_bazel"
        else
          echo "‚úÖ Bazel is up to date"
        fi
      
    - name: Check for rules_rust updates
      run: |
        echo "üîç Checking for rules_rust updates..."
        # Would check rules_rust releases if we had the repo URL
        echo "‚ÑπÔ∏è rules_rust check would go here"

  # Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    schedule:
      - cron: '0 0 * * 0'  # Run weekly on Sunday
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Run security audit
      run: |
        echo "üîí Running security audit..."
        
        # Check for sensitive information
        echo "Checking for secrets..."
        if grep -r "password\|secret\|api_key\|token" . --exclude-dir=.git 2>/dev/null; then
          echo "‚ö†Ô∏è Potential secrets found"
          exit 1
        else
          echo "‚úÖ No obvious secrets found"
        fi
        
        # Check file permissions
        echo "Checking file permissions..."
        find . -type f -name "*.sh" -exec test -x {} \; && echo "‚úÖ Shell scripts are executable" || echo "‚ö†Ô∏è Some shell scripts may need executable permissions"
        
        # Check for large files
        echo "Checking for large files..."
        large_files=$(find . -type f -size +10M -not -path "./test_releases/*" 2>/dev/null)
        if [ -n "$large_files" ]; then
          echo "‚ö†Ô∏è Large files found:"
          echo "$large_files"
        else
          echo "‚úÖ No unexpectedly large files"
        fi
        
        echo "‚úÖ Security audit completed"
