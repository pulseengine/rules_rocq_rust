name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BAZEL_VERSION: 8.1.0

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Cache Bazel
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/bazel
          ~/.bazel
        key: ${{ runner.os }}-bazel-${{ hashFiles('**/MODULE.bazel', '**/WORKSPACE', '**/BUILD*') }}
        restore-keys: |
          ${{ runner.os }}-bazel-
    
    - name: Run basic tests
      run: bazel test //test:test_basic
    
    - name: Run toolchain tests
      run: bazel test //test:toolchain_test
    
    - name: Run toolchain download tests
      run: bazel test //test:toolchain_download_test
    
    - name: Run integration tests
      run: bazel test //test:integration_test
    
    - name: Test local coq-of-rust build
      run: |
        if [ -d "third_party/coq_of_rust" ]; then
          echo "Testing local coq-of-rust build..."
          bazel test //examples/rust_integration:test_all
        else
          echo "Local coq-of-rust not available, skipping test"
        fi
    
    - name: Test examples
      run: bazel test //examples/...:test
    
    - name: Test proof validation metrics
      run: bazel test //examples/advanced_validation:test_all
    
    - name: Test real download functionality
      run: |
        if [ -d "test_releases" ]; then
          echo "Testing real download functionality..."
          bazel test //test:real_download_test
        else
          echo "Real download tests require test releases (run create_test_releases.py)"
        fi
    
    - name: Test complete workflow
      run: bazel test //test:complete_workflow_test
    
    - name: Test comprehensive integration
      run: bazel test //test:integration_test_comprehensive
    
    - name: Run security audit
      run: |
        echo "Running security audit..."
        ./scripts/security_audit.sh || echo "Security audit completed with warnings"
    
    - name: Test pulseengine integration examples
      run: bazel test //examples/pulseengine_integration:test_all
    
    - name: Build all targets
      run: bazel build //...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Run buildifier
      run: |
        bazel run @buildifier -- --lint=fix
        git diff --exit-code || (echo "Buildifier found formatting issues"; exit 1)
    
    - name: Check for common issues
      run: |
        echo "Checking for common Bazel issues..."
        # Check for missing load statements
        ! grep -r "load(" --include="*.bzl" . | grep -v "load(\"" || echo "All load statements use quotes"
        # Check for proper visibility
        ! grep -r "visibility = \[\]" --include="*.bzl" . || echo "All visibility declarations are proper"

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check documentation
      run: |
        echo "Checking documentation completeness..."
        # Check that all rules have doc strings
        grep -r "def \w\+(" --include="*.bzl" . | while read -r line; do
          if ! grep -A5 "$line" | grep -q '"""'; then
            echo "Missing docstring for: $line"
            exit 1
          fi
        done
        
        # Check that all examples have README files
        for dir in examples/*/; do
          if [ -d "$dir" ] && [ ! -f "$dir/README.md" ]; then
            echo "Missing README.md in: $dir"
            exit 1
          fi
        done
        
        echo "All rules have documentation"
        echo "All examples have README files"

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [test, lint, docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v2
      with:
        bazelisk-version: ${{ env.BAZEL_VERSION }}
    
    - name: Build release artifacts
      run: |
        bazel build //...:all
        mkdir -p release_artifacts
        cp -r bazel-bin/* release_artifacts/
    
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: release_artifacts/**
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}