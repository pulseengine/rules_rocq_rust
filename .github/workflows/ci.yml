name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Pin nixpkgs for reproducibility
  NIXPKGS_CHANNEL: nixpkgs=channel:nixos-unstable

jobs:
  # Basic loading verification (fast, no nix required)
  verify-rules:
    name: Verify Rules Load
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-verify-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-verify-${{ runner.os }}-

    - name: Verify rules load
      run: |
        echo "Verifying Bazel rules load..."
        bazel query //rocq/...
        bazel query //coq_of_rust/...
        echo "Rules load successfully"

  # Full build with nix toolchain (Linux)
  build:
    name: Build Example (Linux)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v30
      with:
        nix_path: ${{ env.NIXPKGS_CHANNEL }}

    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nix-community
        # Using public nix-community cache for common packages

    - name: Cache Nix store
      uses: actions/cache@v4
      with:
        path: /nix/store
        key: nix-store-${{ runner.os }}-${{ hashFiles('rocq/private/toolchain.bzl') }}
        restore-keys: |
          nix-store-${{ runner.os }}-

    - name: Install LLVM for Rust nightly
      run: |
        # rocq-of-rust requires rustc_private which links against LLVM
        sudo apt-get update
        sudo apt-get install -y llvm-dev libclang-dev

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        toolchain: nightly-2024-12-01
        components: rustc-dev, rust-src

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-build-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-build-${{ runner.os }}-

    - name: Build RocqOfRust library
      run: |
        echo "Building RocqOfRust library..."
        bazel build @rocq_of_rust_source//:rocq_of_rust_main
        echo "RocqOfRust library built"

    - name: Build example proofs
      run: |
        echo "Building example proofs..."
        bazel build //examples/rust_to_rocq:point_proofs
        echo "Example proofs verified"

    - name: Build advanced example
      run: |
        echo "Building advanced Rust features example..."
        bazel build //examples/rust_to_rocq:advanced_verified
        echo "Advanced example verified"

  # macOS build
  build-macos:
    name: Build Example (macOS)
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v30
      with:
        nix_path: ${{ env.NIXPKGS_CHANNEL }}

    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nix-community

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-build-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-build-${{ runner.os }}-

    - name: Build example proofs
      run: |
        echo "Building example proofs on macOS..."
        bazel build //examples/rust_to_rocq:point_proofs
        echo "Example proofs verified on macOS"

    - name: Build advanced example
      run: |
        echo "Building advanced Rust features example..."
        bazel build //examples/rust_to_rocq:advanced_verified
        echo "Advanced example verified"

  # Buildifier check
  buildifier:
    name: Buildifier Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Check formatting
      run: |
        curl -Lo buildifier https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildifier-linux-amd64
        chmod +x buildifier
        ./buildifier --mode=check -r . || echo "Some files need formatting"
