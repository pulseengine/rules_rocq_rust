name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Pin nixpkgs for reproducibility
  NIXPKGS_CHANNEL: nixpkgs=channel:nixos-unstable

jobs:
  # Basic loading verification (fast, no nix required)
  verify-rules:
    name: Verify Rules Load
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-verify-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-verify-${{ runner.os }}-

    - name: Verify rules load
      run: |
        echo "Verifying Bazel rules load..."
        bazel query //rocq/...
        bazel query //coq_of_rust/...
        echo "Rules load successfully"

  # Full build with nix toolchain (Linux)
  build:
    name: Build Example (Linux)
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v30
      with:
        nix_path: ${{ env.NIXPKGS_CHANNEL }}

    - name: Install Rust nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        toolchain: nightly-2024-12-01
        components: rustc-dev, rust-src, llvm-tools-preview

    - name: Set Rust library paths
      run: |
        # Get Rust sysroot and add its lib directory to library paths
        RUST_SYSROOT=$(rustc +nightly-2024-12-01 --print sysroot)
        echo "RUST_SYSROOT=$RUST_SYSROOT"
        ls -la $RUST_SYSROOT/lib/ | head -10
        echo "LIBRARY_PATH=$RUST_SYSROOT/lib:$LIBRARY_PATH" >> $GITHUB_ENV
        echo "LD_LIBRARY_PATH=$RUST_SYSROOT/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-build-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-build-${{ runner.os }}-

    - name: Clean rocq-of-rust cache
      run: |
        # Force re-fetch of rocq-of-rust to pick up new LLVM libs
        bazel clean --expunge_async || true
        rm -rf ~/.cache/bazel/*rocq_of_rust* || true

    - name: Build RocqOfRust library
      run: |
        echo "Building RocqOfRust library..."
        bazel build @rocq_of_rust_source//:rocq_of_rust_main
        echo "RocqOfRust library built"

    - name: Build example proofs
      run: |
        echo "Building example proofs..."
        bazel build //examples/rust_to_rocq:point_proofs
        echo "Example proofs verified"

    - name: Build advanced example
      run: |
        echo "Building advanced Rust features example..."
        bazel build //examples/rust_to_rocq:advanced_verified
        echo "Advanced example verified"

    - name: Collect verified artifacts
      run: |
        mkdir -p verified-artifacts
        # Copy compiled proof files
        find bazel-bin/examples -name "*.vo" -exec cp {} verified-artifacts/ \;
        find bazel-bin/examples -name "*.v" -exec cp {} verified-artifacts/ \;
        ls -la verified-artifacts/

    - name: Upload verified artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verified-proofs-linux
        path: verified-artifacts/

    - name: Attest build provenance
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: verified-artifacts/*

  # macOS build
  build-macos:
    name: Build Example (macOS)
    runs-on: macos-latest
    permissions:
      id-token: write
      contents: read
      attestations: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v30
      with:
        nix_path: ${{ env.NIXPKGS_CHANNEL }}

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: ~/.cache/bazel
        key: bazel-build-${{ runner.os }}-${{ hashFiles('MODULE.bazel', 'MODULE.bazel.lock') }}
        restore-keys: |
          bazel-build-${{ runner.os }}-

    - name: Build example proofs
      run: |
        echo "Building example proofs on macOS..."
        bazel build //examples/rust_to_rocq:point_proofs
        echo "Example proofs verified on macOS"

    - name: Build advanced example
      run: |
        echo "Building advanced Rust features example..."
        bazel build //examples/rust_to_rocq:advanced_verified
        echo "Advanced example verified"

    - name: Collect verified artifacts
      run: |
        mkdir -p verified-artifacts
        find bazel-bin/examples -name "*.vo" -exec cp {} verified-artifacts/ \;
        find bazel-bin/examples -name "*.v" -exec cp {} verified-artifacts/ \;
        ls -la verified-artifacts/

    - name: Upload verified artifacts
      uses: actions/upload-artifact@v4
      with:
        name: verified-proofs-macos
        path: verified-artifacts/

    - name: Attest build provenance
      uses: actions/attest-build-provenance@v2
      with:
        subject-path: verified-artifacts/*

  # Buildifier check
  buildifier:
    name: Buildifier Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Check formatting
      run: |
        curl -Lo buildifier https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildifier-linux-amd64
        chmod +x buildifier
        ./buildifier --mode=check -r . || echo "Some files need formatting"
